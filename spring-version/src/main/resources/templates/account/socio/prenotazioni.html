<div xmlns:th="http://www.thymeleaf.org"
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
     layout:decorate="~{layout}"
     layout:fragment="content">
    <!-- Nessuna prenotazione -->
    <div class="row p-4" th:if="${richieste.isEmpty()}">
        <div class="col">
            <div class="card p-4">
                <h4 class="font-weight-bolder text-center" th:text="#{no_prenotations}"></h4>
            </div>
        </div>
    </div>
    <!-- Lista prenotazioni -->
    <div class="row p-4" th:unless="${richieste.isEmpty()}">
        <div class="col-lg-3 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="row justify-content-center mb-4 font-weight-bold" th:text="#{qr_code}"></div>
                    <div class="d-flex justify-content-center mb-4" id="qrcode"></div>
                    <div id="assegnazione" class="row justify-content-center mb-4 font-weight-bold"></div>
                    <div class="row text-center mt-4">
                        <span class="mb-2 text-sm">
                        <span th:text="#{code}"></span> #<span id="codice" class="font-weight-bold"></span>
                        </span>
                        <span class="mb-2 text-sm">
                        <span th:text="#{price}"></span> <span id="costo" class="font-weight-bold"></span>â‚¬
                        </span>
                        <span class="mb-2 text-sm">
                        <span th:text="#{time}"></span> <span id="orario" class="font-weight-bold"></span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-6 mb-4 col-lg-4" th:each="richiesta : ${richieste}">
                            <div class="card prenotazione nav-link selezione"
                                 th:attr="data-prenotazione=${richiesta.prenotazione},
                                data-assegnata=${richiesta.assegnazione != null},
                                data-orario=${richiesta.assegnazione != null ? richiesta.assegnazione.orario : ''},
                                data-costo=${richiesta.assegnazione != null ? richiesta.assegnazione.costo : ''}">
                                <div class="card-body p-3 d-flex flex-column">
                                    <h6 class="mb-3 text-md"
                                        th:text="#{prenotation(${richiesta.prenotazione})}"></h6>
                                    <span class="mb-2 text-sm">
                                    <span th:text="#{platform}"></span>
                                    <img class="piattaforma"
                                         th:src="@{/assets/img/console/{tipo}.jpg(tipo=${richiesta.postazione.dispositivoDiGioco.getTipo().toLowerCase()})}">
                                    <span class="text-dark font-weight-bold"
                                          th:text="${richiesta.postazione.dispositivoDiGioco.tipo}"></span>
                                    </span>
                                    <span class="mb-2 text-sm">
                                    <span th:text="#{station}"></span> #<span class="text-dark font-weight-bold" th:text="${richiesta.postazione.numero}"></span>
                                    </span>
                                    <span class="mb-2 text-sm">
                                    <span th:text="#{duration}"></span>
                                    <span class="text-dark font-weight-bold"
                                          th:text="${richiesta.durata}"></span>
                                    </span>
                                    <span class="mb-2 text-sm">
                                        <span th:text="#{status}"></span>
                                        <th:block th:if="${richiesta.assegnazione != null}">
                                            <img class="genere-img ok" style="margin-right: 0px;">
                                            <span class="text-dark font-weight-bold" th:text="#{assigned}"></span>
                                        </th:block>
                                        <th:block th:unless="${richiesta.assegnazione != null}">
                                            <img class="genere-img no" style="margin-right: 0px;">
                                            <span class="text-dark font-weight-bold" th:text="#{not_assigned}"></span>
                                        </th:block>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <th:block th:unless="${richieste.isEmpty()}">
        <script th:src="@{/assets/js/qrcode.min.js}"></script>
        <script th:inline="javascript">
            const assignedLabel = [[#{assigned.long}]];
            const notAssignedLabel = [[#{not_assigned.long}]];

            const prenotazioni = document.getElementsByClassName("prenotazione");
            const qr = document.getElementById("qrcode");
            const assegnazione = document.getElementById("assegnazione");
            const codice = document.getElementById("codice");
            const orario = document.getElementById("orario");
            const costo = document.getElementById("costo");

            var lastElemento = null;

            for (var i = 0; i < prenotazioni.length; i++) {
                const elemento = prenotazioni[i];

                elemento.addEventListener('click', function () {
                    if (lastElemento != null) {
                        lastElemento.classList.remove("active");
                        qr.innerHTML = "";
                    }

                    elemento.classList.add("active");

                    const getPrenotazione = elemento.getAttribute("data-prenotazione");
                    const getOrario = elemento.getAttribute("data-orario");
                    const getCosto = elemento.getAttribute("data-costo");
                    const assegnata = elemento.getAttribute("data-assegnata") === "true";

                    new QRCode(qr, { text: getPrenotazione, width: 190, height: 190 });

                    assegnazione.innerHTML = assegnata ? assignedLabel : notAssignedLabel;
                    assegnazione.classList.remove("text-success", "text-danger");
                    assegnazione.classList.add(assegnata ? "text-success" : "text-danger");

                    codice.innerHTML = getPrenotazione;

                    costo.parentElement.style.display  = assegnata ? "block" : "none";
                    orario.parentElement.style.display = assegnata ? "block" : "none";

                    if (assegnata) {
                      costo.innerHTML  = (Math.round(getCosto * 100) / 100);
                      orario.innerHTML = getOrario;
                    }

                    lastElemento = elemento;
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });

                if (i === 0) {
                    elemento.click();
                }
            }
        </script>
    </th:block>
</div>